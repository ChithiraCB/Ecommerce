{% load static %}
{% include 'includes/productheader.html' %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/checkout3.css' %}">
<link rel="stylesheet" href="{% static 'css/orderstatus.css' %}">

<!-- Modal -->
<div id="myModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Cancel Order</h2>
    <div class="modal-body">
      <form id="cancelForm">
        <label for="reason">Reason for cancellation:</label><br>
        <select id="reason" name="reason" required>
          <option value="" selected disabled>Select a reason</option>
          <option value="Changed Mind">Changed Mind</option>
          <option value="Found Better Deal">Found Better Deal</option>
          <option value="Wrong Size/Color">Wrong Size/Color</option>
          <option value="Delayed Delivery">Delayed Delivery</option>
          <option value="Financial Issues">Financial Issues</option>
          <option value="Quality Concerns">Quality Concerns</option>
          <option value="other">Other</option>
        </select><br><br>
        <label for="comments">Comments :</label><br>
        <textarea id="comments" name="comments" rows="4" placeholder="Max 25 words" required></textarea><br><br>
        <button type="submit" class="btn cancel-btn">Submit</button>
      </form>
    </div>
  </div>
</div>

<div class="container">
  <h1>Order Status</h1>
  <div class="order-status">
    <div class="status-item">
      <span>Order Number:</span>
      <p>#{{ order_id }}</p>
      
    </div>
    <div class="status-item">
        <span>Products:</span>
        <ul>
          {% for product in products %}
            <li>{{ product.product_name}}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="status-item">
        <span>Total Amount:</span>
        {{ total_amount }}
      </div>

    <div class="status-item">
      <span>Status:</span>
      {{ status }}
    </div>
    {% comment %} <div class="status-item">
      <span>Estimated Delivery:</span>
      <p>March 5, 2024</p>
    </div> {% endcomment %}
    {% comment %} <div class="status-item">
      <span>Shipping Address:</span>
      {{user_address.address}}
    
    </div> {% endcomment %}
  </div>
  <a href="#" class="btn">Track Order</a>
 
  
  <button id="cancelBtn" class="btn cancel-btn">Cancel Order</button>
</div>

<script>
  // Get the modal
  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.getElementById("cancelBtn");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks the button, open the modal 
  btn.onclick = function() {
    modal.style.display = "block";
    document.body.classList.add("modal-open");
  }

  // When the user clicks on <span> (x), close the modal
  span.onclick = function() {
    modal.style.display = "none";
    document.body.classList.remove("modal-open");
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
      document.body.classList.remove("modal-open");
    }
  }

  // Handle form submission
  document.getElementById("cancelForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent form submission
    
    // Validate reason and comments fields
    var reason = document.getElementById("reason").value;
    var comments = document.getElementById("comments").value;

    if (!reason || !comments) {
      alert("Both reason and comments are required.");
      return;
    }

    // You can handle form submission here, e.g., by sending an AJAX request
    console.log("Reason for cancellation:", reason);
    console.log("Comments:", comments);
    modal.style.display = "none"; // Close modal after submission
    document.body.classList.remove("modal-open");
  });

  // Validate comments field for maximum word count
  document.getElementById("comments").addEventListener("input", function() {
    var comments = this.value.trim();
    var words = comments.split(/\s+/).length;
    
    if (words > 25) {
      this.setCustomValidity("Maximum 25 words allowed.");
    } else {
      this.setCustomValidity("");
    }
  });

  document.getElementById("cancelForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent form submission
    
    // Get reason and comments
    var reason = document.getElementById("reason").value;
    var comments = document.getElementById("comments").value;
  
    // Send AJAX request to cancel order
    var orderId = "{{ order_id }}";  // Replace with actual order ID
    var url = "/ordercancellation/" + orderId + "/";
    var data = {
      'reason': reason,
      'comments': comments
    };
  
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')  // Include CSRF token
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (response.ok) {
        alert("Order cancelled successfully.");
        // Optionally, update the UI to reflect the cancelled order
      } else {
        alert("Failed to cancel order.");
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("An error occurred while cancelling the order.");
    });
  });
  
  // Function to get CSRF token from cookies
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
</script>

{% endblock %}
